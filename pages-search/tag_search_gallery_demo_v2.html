<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tag Search Demo ‚Äì Clean Rebuild</title>
  <style>
    /* -----------------------------------------------------------
      Base styles
    ----------------------------------------------------------- */
    :root{
      --bg: #0b1220;
      --panel: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #22d3ee;
      --accent-2: #a78bfa;
      --chip: #1e293b;
      --chip-text: #e2e8f0;
      --danger:#ef4444;
      --ok:#10b981;
      --border: #233147;
      --shadow: 0 6px 24px rgba(3,8,20,.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, #162238, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2336, transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    .container{ max-width: 1100px; margin: 40px auto; padding: 0 16px 80px; }
    h1{ font-size: clamp(22px, 3.6vw, 32px); margin: 0 0 16px; letter-spacing: 0.2px; }
    p.sub{ margin: 0 0 20px; color: var(--muted); }

    /* -----------------------------------------------------------
      Search / tag input with chips and autosuggest
    ----------------------------------------------------------- */
    .search-card{ background: linear-gradient(180deg, #0f172a 0%, #0d1526 100%); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; }
    .bar{ display:flex; gap: 10px; align-items: center; flex-wrap: wrap; position: relative; }

    .input-wrap{ display:flex; align-items:center; flex:1 1 260px; min-width:220px; background:#0b1324; border:1px solid #24324d; border-radius: 9px; padding: 8px 10px; gap:8px; }
    .input-wrap input{ background: transparent; border: 0; outline: none; color: var(--text); font-size: 15px; flex: 1; min-width: 120px; }
    .input-wrap input::placeholder{ color:#5a6a86 }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; background: var(--chip); color: var(--chip-text); padding: 6px 10px; border-radius: 999px; border: 1px solid #2b3a55; font-size: 13px; line-height: 1; }
    .chip .x{ width:18px; height:18px; display:grid; place-items:center; border-radius: 50%; border:1px solid #334566; cursor: pointer; user-select:none; }

    .suggest{ position: absolute; left: 0; right: 0; top: calc(100% + 8px); background:#0b1324; border:1px solid #273a5a; border-radius: 10px; overflow:hidden; box-shadow: var(--shadow); max-height: 260px; overflow-y: auto; z-index: 20; }
    .suggest.hidden{ display:none }
    .suggest-item{ padding: 10px 12px; cursor: pointer; font-size: 14px; display:flex; align-items:center; gap:10px; }
    .suggest-item:hover, .suggest-item.active{ background:#0e1a31 }
    .suggest-item .pill{ margin-left:auto; font-size:12px; opacity:.7 }

    .filters-row{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 10px; }
    .filters-row .input-wrap{ min-width: unset; }

    .controls{ display:flex; gap:10px; align-items:center; margin-top: 12px; flex-wrap:wrap }
    .toggle{ display:inline-flex; align-items:center; gap:8px; background:#0c1527; border:1px solid #294063; padding:8px 10px; border-radius: 10px; font-size: 13px; color: var(--muted); }

    /* -----------------------------------------------------------
      Gallery grid
    ----------------------------------------------------------- */
    .grid{ margin-top: 18px; display:grid; gap: 14px; grid-template-columns: repeat( auto-fill, minmax(230px, 1fr) ); }
    .card{ background: var(--panel); border:1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); overflow: hidden; }
    .thumb{ aspect-ratio: 4/3; display:grid; place-items:center; background: linear-gradient(135deg, rgba(167,139,250,.2), rgba(34,211,238,.15)); border-bottom: 1px solid var(--border); font-weight:700; font-size: 24px; letter-spacing: .5px; color:#dfe7ff; }
    .meta{ padding: 10px 12px; display:flex; flex-direction:column; gap:10px; }
    .title{ font-weight:700; }
    .tags{ display:flex; gap:6px; flex-wrap: wrap }
    .tag{ font-size: 11px; padding:4px 8px; background:#0b1324; border:1px solid #2a3b58; border-radius:999px; color:#cfe0ff; cursor:pointer; user-select:none }

    .no-results{ border: 1px dashed #2c3f63; padding: 14px; border-radius: 10px; color: var(--muted); }
    .download{ margin-top: 22px; font-size:14px; }
    .download a{ color: var(--accent); font-weight: 600; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Search by Tags ‚Äì Demo</h1>
    <p class="sub">Type to search tags. Press <strong>Enter</strong> to add the top suggestion, or click a suggestion. Selected tags appear below as chips. Click a tag on any card to add it to the filter.</p>

    <section class="search-card" aria-label="Tag search and filters">
      <!-- Search bar with autosuggest -->
      <div class="bar" id="bar">
        <div class="input-wrap" role="combobox" aria-haspopup="listbox" aria-expanded="false">
          <span aria-hidden="true">üîé</span>
          <input id="tag-input" type="text" placeholder="Search tags (e.g. Vintage)" autocomplete="off" aria-autocomplete="list" />
        </div>
        <div id="suggest" class="suggest hidden" role="listbox" aria-label="Tag suggestions"></div>
      </div>

      <!-- Selected tags moved BELOW the search bar -->
      <div id="selectedTags" class="chips" aria-label="Selected tags"></div>

      <!-- Optional extra filter: Design name (free-text) -->
      <div class="filters-row">
        <div class="input-wrap" title="Type to filter by item title only">
          <span aria-hidden="true">üÖ∞Ô∏è</span>
          <input id="design-input" type="text" placeholder="Filter by design name (title)" autocomplete="off" />
        </div>
      </div>

      <div class="controls">
        <label class="toggle"><input id="modeAny" type="checkbox"/> Match ANY tag (instead of ALL)</label>
        <button id="clearAll" class="btn" type="button">Clear tags</button>
      </div>
    </section>

    <div id="summary" class="download" aria-live="polite"></div>

    <section aria-label="Results">
      <div id="grid" class="grid" role="list"></div>
      <div id="empty" class="no-results" style="display:none">No items match the selected filters.</div>
    </section>

    <p class="download">Want this as a file? <a id="downloadLink" href="#">Download the HTML</a></p>
  </div>

  <script>
    /* ===========================================================
      TAG SEARCH DEMO ‚Äì Clean rebuild, vanilla JS

      ‚úî 20 allowed tags (source of truth)
      ‚úî Autosuggest with prefix/contains + Levenshtein fallback
      ‚úî Selected tags below the search bar (chips)
      ‚úî Click a tag in gallery to add to active filters
      ‚úî AND / ANY tag match modes
      ‚úî Optional design-name text filter (titles only)
      ‚úî In-page download link
    =========================================================== */

    /* -----------------------------------------------------------
      1) DATA: Allowed tags + Mock items
    ----------------------------------------------------------- */
    const ALLOWED_TAGS = [
      "Minimal","Vintage","Sport","Casual","Outdoor","Formal","Eco","Tech","Art","Travel",
      "Music","Gaming","Fitness","Foodie","Photography","Streetwear","Luxury","Handmade","Boho","Monochrome"
    ];

    function makeMockItems(count=36){
      const items = [];
      for(let i=1;i<=count;i++){
        const chosen = new Set();
        const tagCount = 3 + Math.floor(Math.random()*4);
        while(chosen.size < tagCount){
          chosen.add(ALLOWED_TAGS[Math.floor(Math.random()*ALLOWED_TAGS.length)]);
        }
        // Optional: a few more interesting names for the title filter demo
        const names = ["Aurora", "Orbit", "MonoGrid", "Boho Bloom", "Nocturne", "Voyager", "Pixel Pop", "Serif Sun", "Street Pulse", "Zenith"];
        const title = `${names[i % names.length]} ${i.toString().padStart(2,'0')}`;
        items.push({ id:i, title, tags:[...chosen] });
      }
      return items;
    }

    let ITEMS = makeMockItems();
    let activeTags = new Set();
    let designQuery = ""; // free-text filter for item.title

    /* -----------------------------------------------------------
      2) FUZZY MATCHING UTILITIES (Levenshtein + helpers)
    ----------------------------------------------------------- */
    function levenshtein(a,b){
      a = a.toLowerCase(); b = b.toLowerCase();
      const dp = Array(b.length + 1).fill(0).map((_,i)=>i);
      for(let i=1;i<=a.length;i++){
        let prev = i;
        for(let j=1;j<=b.length;j++){
          const tmp = dp[j];
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          dp[j] = Math.min(dp[j] + 1, prev + 1, dp[j-1] + cost);
          prev = tmp;
        }
        dp[0] = i;
      }
      return dp[b.length];
    }

    function suggestTags(query, limit=8){
      if(!query) return [];
      const q = query.trim().toLowerCase();
      const scored = ALLOWED_TAGS
        .filter(t => !activeTags.has(t))
        .map(t => {
          const tl = t.toLowerCase();
          let bucket = 3;
          if(tl.startsWith(q)) bucket = 0; else if(tl.includes(q)) bucket = 1;
          const dist = levenshtein(q, tl);
          return { tag:t, bucket, dist };
        });
      scored.sort((a,b)=> a.bucket - b.bucket || a.dist - b.dist || a.tag.localeCompare(b.tag));
      return scored.slice(0, limit).map(s=>s.tag);
    }

    /* -----------------------------------------------------------
      3) DOM HELPERS ‚Äì rendering chips, suggestions, and grid
    ----------------------------------------------------------- */
    const els = {
      bar: document.getElementById('bar'),
      input: document.getElementById('tag-input'),
      suggest: document.getElementById('suggest'),
      grid: document.getElementById('grid'),
      empty: document.getElementById('empty'),
      modeAny: document.getElementById('modeAny'),
      clearAll: document.getElementById('clearAll'),
      summary: document.getElementById('summary'),
      downloadLink: document.getElementById('downloadLink'),
      selectedTags: document.getElementById('selectedTags'),
      designInput: document.getElementById('design-input')
    };

    function renderChips(){
      els.selectedTags.innerHTML = '';
      for(const t of activeTags){
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span aria-hidden="true">#</span>${t}<button class="x" aria-label="Remove tag ${t}" title="Remove">√ó</button>`;
        chip.querySelector('.x').addEventListener('click', ()=>{ activeTags.delete(t); update(); els.input.focus(); });
        els.selectedTags.appendChild(chip);
      }
    }

    function renderSuggest(list){
      els.suggest.innerHTML = '';
      if(!list.length){ els.suggest.classList.add('hidden'); els.bar.querySelector('.input-wrap').setAttribute('aria-expanded','false'); return; }
      list.forEach((t,i)=>{
        const item = document.createElement('div');
        item.className = 'suggest-item' + (i===0 ? ' active' : '');
        item.role = 'option';
        item.setAttribute('aria-selected', i===0 ? 'true' : 'false');
        item.innerHTML = `<span>#</span>${t}<span class="pill">add</span>`;
        item.addEventListener('click', ()=> addTag(t));
        els.suggest.appendChild(item);
      });
      els.suggest.classList.remove('hidden');
      els.bar.querySelector('.input-wrap').setAttribute('aria-expanded','true');
    }

    function renderGrid(){
      const anyMode = els.modeAny.checked;
      const req = [...activeTags];
      const dq = designQuery.trim().toLowerCase();
      const visible = ITEMS.filter(it => {
        const tagPass = req.length === 0 ? true : (anyMode ? it.tags.some(t=>activeTags.has(t)) : req.every(t=>it.tags.includes(t)));
        const namePass = dq ? it.title.toLowerCase().includes(dq) : true;
        return tagPass && namePass;
      });

      els.grid.innerHTML = '';
      visible.forEach(it =>{
        const card = document.createElement('article');
        card.className = 'card';
        card.role = 'listitem';
        const tagsHtml = it.tags.map(t=>`<span class="tag" data-tag="${t}">${t}</span>`).join('');
        card.innerHTML = `
          <div class="thumb">${it.title}</div>
          <div class="meta">
            <div class="title">${it.title}</div>
            <div class="tags">${tagsHtml}</div>
          </div>`;
        // Delegate: clicking a tag adds to active filters
        card.querySelectorAll('.tag').forEach(el => {
          el.addEventListener('click', () => addTag(el.dataset.tag));
        });
        els.grid.appendChild(card);
      });

      els.empty.style.display = visible.length ? 'none' : 'block';
      const parts = [];
      parts.push(`${visible.length} / ${ITEMS.length} items shown`);
      if(activeTags.size) parts.push(`tags: ${[...activeTags].join(', ')}`);
      if(dq) parts.push(`design: ‚Äú${dq}‚Äù`);
      els.summary.innerHTML = parts.join(' ¬∑ ');
    }

    function update(){
      renderChips();
      renderGrid();
      const q = els.input.value.trim();
      renderSuggest(q ? suggestTags(q) : []);
    }

    /* -----------------------------------------------------------
      4) INTERACTIONS ‚Äì adding/removing tags, keyboard UX
    ----------------------------------------------------------- */
    function addTag(tag){
      if(!ALLOWED_TAGS.includes(tag)) return; // only allowed tags
      if(activeTags.has(tag)) return;         // avoid duplicates
      activeTags.add(tag);
      els.input.value = '';
      update();
    }

    function maybeBackspaceRemove(e){
      if(e.key === 'Backspace' && !els.input.value && activeTags.size){
        const last = [...activeTags].pop();
        activeTags.delete(last);
        update();
        e.preventDefault();
      }
    }

    function handleAddKeys(e){
      if(e.key === 'Enter' || e.key === ','){
        const first = els.suggest.querySelector('.suggest-item');
        if(first){ addTag(first.textContent.trim()); }
        e.preventDefault();
      }
      if(e.key === 'ArrowDown' || e.key === 'ArrowUp'){
        const items = [...els.suggest.querySelectorAll('.suggest-item')];
        if(!items.length) return;
        let idx = items.findIndex(n=>n.classList.contains('active'));
        idx = (e.key === 'ArrowDown') ? (idx+1) : (idx-1);
        if(idx < 0) idx = items.length-1;
        if(idx >= items.length) idx = 0;
        items.forEach(n=>{ n.classList.remove('active'); n.setAttribute('aria-selected','false'); });
        items[idx].classList.add('active'); items[idx].setAttribute('aria-selected','true');
      }
    }

    function onInput(){
      const q = els.input.value.trim();
      renderSuggest(q ? suggestTags(q) : []);
    }

    function onDocClick(e){
      if(!els.bar.contains(e.target)){
        els.suggest.classList.add('hidden');
        els.bar.querySelector('.input-wrap').setAttribute('aria-expanded','false');
      }
    }

    /* -----------------------------------------------------------
      5) DOWNLOAD BUTTON & INIT
    ----------------------------------------------------------- */
    function makeDownload(){
      const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      els.downloadLink.href = url;
      els.downloadLink.download = 'tag-search-demo-clean.html';
    }

    function init(){
      els.input.addEventListener('input', onInput);
      els.input.addEventListener('keydown', handleAddKeys);
      els.input.addEventListener('keydown', maybeBackspaceRemove, {capture:true});

      els.designInput.addEventListener('input', () => { designQuery = els.designInput.value; update(); });

      els.modeAny.addEventListener('change', update);
      els.clearAll.addEventListener('click', ()=>{ activeTags.clear(); update(); els.input.focus(); });
      document.addEventListener('click', onDocClick);

      update();
      makeDownload();
    }

    init();
  </script>
</body>
</html>
