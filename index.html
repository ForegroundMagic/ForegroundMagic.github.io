<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shirt Mockup Preview — 1155×1155 Fronts + SVG Overlay</title>
  <style>
    :root { --ink: #ffffff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background:#0b0b0c; color:#e6e7ea; display:grid; grid-template-rows:auto 1fr; min-height:100dvh; gap:16px; }
    header { padding:14px 18px; border-bottom:1px solid #1e232d; background:#0f1115; }
    header h1 { font-size:16px; margin:0; font-weight:600; }
    .wrap { display:grid; grid-template-columns: 340px 1fr; gap:16px; padding:16px; }
    @media (max-width: 1000px){ .wrap { grid-template-columns: 1fr; } }
    .panel { background:#0f1115; border:1px solid #1e232d; border-radius:12px; padding:14px; box-shadow:0 1px 0 #1c2230 inset; }
    .panel h2 { font-size:13px; margin:0 0 10px; text-transform:uppercase; letter-spacing:.06em; opacity:.85; }
    .row { display:grid; grid-template-columns: 120px 1fr; gap:10px; align-items:center; margin:10px 0; }
    label { font-size:13px; opacity:.9; }
    input[type="file"], select, button, .color-input { font:inherit; color:inherit; background:#0c0e12; border:1px solid #293143; border-radius:10px; padding:10px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }

    .stage { border:1px dashed #2a3346; border-radius:16px; padding:16px; background:#111317; display:grid; place-items:center; }
    .stage svg { width:min(86vmin, 840px); height:auto; color:var(--ink); display:block; }

    .swatches { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap:10px; }
    .swatch { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #293143; border-radius:10px; background:#0b0d12; cursor:pointer; }
    .swatch[aria-selected="true"] { outline:2px solid #5b9cff; }
    .chip { width:28px; height:28px; border-radius:50%; border:1px solid #2a3346; background:#444; flex:none; }
    .swatch span { font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint { font-size:12px; opacity:.8; line-height:1.35; }
  </style>
</head>
<body>
  <header>
    <h1>Shirt Mockups (Front, 1155×1155) → Overlay SVG in 400×700 active area</h1>
  </header>

  <div class="wrap">
    <section class="panel">
      <h2>Controls</h2>

      <div class="row">
        <label for="file">Load SVG</label>
        <input id="file" type="file" accept=".svg,image/svg+xml" />
      </div>

      <div class="row">
        <label for="ink">SVG Color</label>
        <input id="ink" class="color-input" type="color" value="#ffffff" />
      </div>

      <div class="row">
        <label>Shirt Color</label>
        <div class="swatches" id="swatches"></div>
      </div>

      <div class="actions">
        <button id="btnClear">Clear SVG</button>
        <button id="btnDownload" disabled>Download Graphic PNG (3423×4533)</button>
      </div>
      <div class="row">
        <label for="toggleOverlay">Overlay frame</label>
        <input id="toggleOverlay" type="checkbox" checked />
      </div>


      <p class="hint">Each mockup image is <strong>1155×1155</strong>. The printable active area is a centered <strong>440×582</strong> slot. Your SVG is fitted to that area without distortion (keeps aspect).</p>
      <p class="hint">If you have icon thumbnails for each color, replace the circular color chips with your images (just set <code>thumb</code> in the config).</p>
    </section>

    <section class="panel">
      <h2>Preview</h2>
      <div id="stage" class="stage" aria-live="polite" aria-busy="false"></div>
    </section>
  </div>

  <script>
    // Base folder for mockups (note the spaces). We'll assemble URLs with encodeURI.
    const MOCKUP_BASE = "./mockups/";

    // Known front mockups (filename and a rough color for the chip)
    const COLORS = [
      {id:1,  slug:'maroon',                  name:'Maroon',                  file:'01_front_maroon.png',                  hex:'#7f1d1d'},
      {id:2,  slug:'athletic_heather',        name:'Athletic Heather',        file:'02_front_athletic_heather.png',        hex:'#b3b3b3'},
      {id:3,  slug:'heather_military_green',  name:'Heather Military Green',  file:'03_front_heather_military_green.png',  hex:'#556b2f'},
      {id:4,  slug:'heather_sand_dune',       name:'Heather Sand Dune',       file:'04_front_heather_sand_dune.png',       hex:'#c1b39a'},
      {id:5,  slug:'heather_mauve',           name:'Heather Mauve',           file:'05_front_heather_mauve.png',           hex:'#c58fa8'},
      {id:6,  slug:'heather_team_purple',     name:'Heather Team Purple',     file:'06_front_heather_team_purple.png',     hex:'#6a4fac'},
      {id:7,  slug:'heather_mint',            name:'Heather Mint',            file:'07_front_heather_mint.png',            hex:'#b7e1d7'},
      {id:8,  slug:'natural',                 name:'Natural',                 file:'08_front_natural.png',                 hex:'#efe7d1'},
      {id:9,  slug:'heather_orange',          name:'Heather Orange',          file:'09_front_heather_orange.png',          hex:'#f2a65a'},
      {id:10, slug:'heather_peach',           name:'Heather Peach',           file:'10_front_heather_peach.png',           hex:'#f3b59f'},
      {id:11, slug:'heather_raspberry',       name:'Heather Raspberry',       file:'11_front_heather_raspberry.png',       hex:'#d16a8f'},
      {id:12, slug:'heather_red',             name:'Heather Red',             file:'12_front_heather_red.png',             hex:'#c94c4c'},
      {id:13, slug:'vintage_black',           name:'Vintage Black',           file:'13_front_vintage_black.png',           hex:'#2a2a2a'},
      {id:14, slug:'vintage_white',           name:'Vintage White',           file:'14_front_vintage_white.png',           hex:'#f2f2f2'},
      {id:15, slug:'pink',                    name:'Pink',                    file:'15_front_pink.png',                    hex:'#f4aecb'},
      {id:16, slug:'forest',                  name:'Forest',                  file:'16_front_forest.png',                  hex:'#154734'},
      {id:17, slug:'white',                   name:'White',                   file:'17_front_white.png',                   hex:'#ffffff'},
      {id:18, slug:'yellow',                  name:'Yellow',                  file:'18_front_yellow.png',                  hex:'#ffd84d'},
      {id:19, slug:'asphalt',                 name:'Asphalt',                 file:'19_front_asphalt.png',                 hex:'#3f3f3f'},
      {id:20, slug:'deep_teal',               name:'Deep Teal',               file:'20_front_deep_teal.png',               hex:'#1d5b5b'},
      {id:21, slug:'heather_royal',           name:'Heather Royal',           file:'21_front_heather_royal.png',           hex:'#4169e1'},
      {id:22, slug:'kelly',                   name:'Kelly',                   file:'22_front_kelly.png',                   hex:'#18a558'},
      {id:23, slug:'red',                     name:'Red',                     file:'23_front_red.png',                     hex:'#e11d48'},
      {id:24, slug:'leaf',                    name:'Leaf',                    file:'24_front_leaf.png',                    hex:'#6bbf59'},
      {id:25, slug:'team_purple',             name:'Team Purple',             file:'25_front_team_purple.png',             hex:'#6a0dad'},
      {id:26, slug:'true_royal',              name:'True Royal',              file:'26_front_true_royal.png',              hex:'#0b5ed7'},
      {id:27, slug:'navy',                    name:'Navy',                    file:'27_front_navy.png',                    hex:'#0b1c3f'},
      {id:28, slug:'orange',                  name:'Orange',                  file:'28_front_orange.png',                  hex:'#f97316'},
      {id:29, slug:'soft_pink',               name:'Soft Pink',               file:'29_front_soft_pink.png',               hex:'#f6c2d1'},
      {id:30, slug:'teal',                    name:'Teal',                    file:'30_front_teal.png',                    hex:'#2dd4bf'},
      {id:31, slug:'turquoise',               name:'Turquoise',               file:'31_front_turquoise.png',               hex:'#14b8a6'},
      {id:32, slug:'black',                   name:'Black',                   file:'32_front_black.png',                   hex:'#111111'},
      {id:33, slug:'canvas_red',              name:'Canvas Red',              file:'33_front_canvas_red.png',              hex:'#b91c1c'},
      {id:34, slug:'cardinal',                name:'Cardinal',                file:'34_front_cardinal.png',                hex:'#8b0000'},
      {id:35, slug:'dark_grey_heather',       name:'Dark Grey Heather',       file:'35_front_dark_grey_heather.png',       hex:'#4b5563'},
      {id:36, slug:'gold',                    name:'Gold',                    file:'36_front_gold.png',                    hex:'#f59e0b'},
      {id:37, slug:'light_blue',              name:'Light Blue',              file:'37_front_light_blue.png',              hex:'#93c5fd'},
      {id:38, slug:'maize_yellow',            name:'Maize Yellow',            file:'38_front_maize_yellow.png',            hex:'#fde047'}
    ];

    const fileInput = document.getElementById('file');
    const inkPicker = document.getElementById('ink');
    const swatches = document.getElementById('swatches');
    const stage = document.getElementById('stage');
    const btnDownload = document.getElementById('btnDownload');
    const btnClear = document.getElementById('btnClear');

    const toggleOverlay = document.getElementById('toggleOverlay');
    let overlayEnabled = true;

    // Geometry
    // const CANVAS_W = 1155, CANVAS_H = 1155; // mockup images are 1155×1155
    // const AREA_W = 440, AREA_H = 582;       // active print area
    // const AREA_X = Math.round((CANVAS_W - AREA_W) / 2); // 378
    // const AREA_Y = Math.round((CANVAS_H - AREA_H) / 2); // 228

    const CANVAS_W = 1155, CANVAS_H = 1155; // mockup images are 1155×1155
    const AREA_W = 440, AREA_H = 582;       // active print area
    const AREA_X = 360;
    const AREA_Y = 180;

    // PNG export target (change to 3420 if preferred)
    const EXPORT_W = 3423, EXPORT_H = 4533;

    let currentSVG = null;        // processed user SVG
    let selectedColor = COLORS[0]; // default selection

    // Build swatch grid
    function buildSwatches(){
      swatches.innerHTML = '';
      COLORS.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'swatch';
        btn.type = 'button';
        btn.setAttribute('data-slug', c.slug);
        btn.setAttribute('aria-selected', c.slug === selectedColor.slug ? 'true' : 'false');

        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.style.background = c.hex || '#666';

        const label = document.createElement('span');
        label.textContent = c.name;

        btn.appendChild(chip);
        btn.appendChild(label);
        btn.addEventListener('click', () => {
          selectedColor = c;
          [...swatches.querySelectorAll('.swatch')].forEach(el => el.setAttribute('aria-selected','false'));
          btn.setAttribute('aria-selected','true');
          render();
        });
        swatches.appendChild(btn);
      });
    }

    buildSwatches();

    // Helpers
    function sanitizeSVG(svgEl){
      svgEl.querySelectorAll('script').forEach(n => n.remove());
      const walker = document.createTreeWalker(svgEl, NodeFilter.SHOW_ELEMENT, null);
      while (walker.nextNode()) {
        const el = walker.currentNode;
        [...el.attributes].forEach(attr => { if (/^on/i.test(attr.name)) el.removeAttribute(attr.name); });
      }
      return svgEl;
    }

    function smartRecolor(svgEl){
      svgEl.querySelectorAll('*').forEach(el => {
        const f = el.getAttribute('fill'); if (f && f.toLowerCase() !== 'none') el.setAttribute('fill','currentColor');
        const s = el.getAttribute('stroke'); if (s && s.toLowerCase() !== 'none') el.setAttribute('stroke','currentColor');
        const st = el.getAttribute('style');
        if (st && /fill\s*:\s*#/i.test(st)) el.style.fill = 'currentColor';
        if (st && /stroke\s*:\s*#/i.test(st)) el.style.stroke = 'currentColor';
      });
      svgEl.style.color = 'var(--ink)';
      return svgEl;
    }
    // TODO fix 400 x 700 into correct dimensions preferably by variables
    function handleSVGString(svgText){
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgText, 'image/svg+xml');
      let svg = doc.querySelector('svg');
      if(!svg){ alert('This file does not appear to be a valid SVG.'); return; }
      svg = sanitizeSVG(svg);
      svg = smartRecolor(svg);
      if (!svg.getAttribute('viewBox')){
        const w = parseFloat(svg.getAttribute('width')) || 400;
        const h = parseFloat(svg.getAttribute('height')) || 700;
        svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      }
      svg.removeAttribute('width');
      svg.removeAttribute('height');
      svg.style.display = 'block';
      currentSVG = svg;
      render();
      btnDownload.disabled = false;
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      if(file.type !== 'image/svg+xml' && !file.name.toLowerCase().endsWith('.svg')){ alert('Please choose an .svg file.'); return; }
      const text = await file.text();
      handleSVGString(text);
    });

    inkPicker.addEventListener('input', () => { stage.style.setProperty('--ink', inkPicker.value); render(); });
    stage.style.setProperty('--ink', inkPicker.value);

        toggleOverlay.addEventListener('change', ()=>{ overlayEnabled = toggleOverlay.checked; render(); });

    btnClear.addEventListener('click', () => { currentSVG = null; render(); btnDownload.disabled = true; });

    function render(){
      stage.innerHTML = '';
      const master = document.createElementNS('http://www.w3.org/2000/svg','svg');
      master.setAttribute('viewBox', `0 0 ${CANVAS_W} ${CANVAS_H}`);
      master.style.width = 'min(86vmin, 840px)';
      master.style.height = 'auto';
      master.style.display = 'block';
      master.style.color = 'var(--ink)';

      // Background mockup image (front)
      if (selectedColor){
        const img = document.createElementNS('http://www.w3.org/2000/svg','image');
        const url = encodeURI(MOCKUP_BASE + selectedColor.file);
        img.setAttribute('href', url);
        img.setAttribute('x','0'); img.setAttribute('y','0');
        img.setAttribute('width', CANVAS_W); img.setAttribute('height', CANVAS_H);
        master.appendChild(img);
      }

      // Active area outline
      const frame = document.createElementNS('http://www.w3.org/2000/svg','rect');
      frame.setAttribute('x', AREA_X); frame.setAttribute('y', AREA_Y);
      frame.setAttribute('width', AREA_W); frame.setAttribute('height', AREA_H);
      frame.setAttribute('fill','none');
      frame.setAttribute('stroke','#000000'); //00e0ff
      frame.setAttribute('stroke-dasharray','6 6'); 
      frame.setAttribute('stroke-opacity','.4');
      frame.setAttribute('stroke-width','4');
      master.appendChild(frame);

      // Art viewport (fits SVG into 400×700 without distortion)
      if (currentSVG){
        const artViewport = document.createElementNS('http://www.w3.org/2000/svg','svg');
        artViewport.setAttribute('x', AREA_X);
        artViewport.setAttribute('y', AREA_Y);
        artViewport.setAttribute('width', AREA_W);
        artViewport.setAttribute('height', AREA_H);
        artViewport.setAttribute('viewBox', currentSVG.getAttribute('viewBox'));
        artViewport.setAttribute('preserveAspectRatio','xMidYMid meet');
        const artClone = currentSVG.cloneNode(true);
        artClone.removeAttribute('width');
        artClone.removeAttribute('height');
        artViewport.appendChild(artClone);
        master.appendChild(artViewport);
      }

      
      // Optional overlay frame (same 1155×1155, sits on top for realistic shading)
      if (overlayEnabled) {
        const overlay = document.createElementNS('http://www.w3.org/2000/svg','image');
        const overlayURL = encodeURI(MOCKUP_BASE + 'overlay_frame.png');
        overlay.setAttribute('href', overlayURL);
        overlay.setAttribute('x','0'); overlay.setAttribute('y','0');
        overlay.setAttribute('width', CANVAS_W); overlay.setAttribute('height', CANVAS_H);
        master.appendChild(overlay);
      }

      stage.appendChild(master);
    }

    //TODO ADDRESS 400 x 700 again
    // ---------- PNG EXPORT (ACTIVE AREA ONLY) ----------
    btnDownload.addEventListener('click', async () => {
      if(!currentSVG){ return; }

      // Build an offscreen SVG that contains ONLY the art viewport content
      const offSVG = document.createElementNS('http://www.w3.org/2000/svg','svg');
      offSVG.setAttribute('xmlns','http://www.w3.org/2000/svg');
      offSVG.setAttribute('width', String(AREA_W));
      offSVG.setAttribute('height', String(AREA_H));
      offSVG.setAttribute('viewBox', currentSVG.getAttribute('viewBox') || '0 0 400 700');
      offSVG.setAttribute('preserveAspectRatio','xMidYMid meet');
      offSVG.style.color = getComputedStyle(stage).getPropertyValue('--ink').trim() || '#000';

      const artClone = currentSVG.cloneNode(true);
      artClone.removeAttribute('width');
      artClone.removeAttribute('height');
      offSVG.appendChild(artClone);

      // Serialize SVG -> Image
      const xml = new XMLSerializer().serializeToString(offSVG);
      const svgBlob = new Blob([xml], {type:'image/svg+xml'});
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.decoding = 'async';
      img.onload = () => {
        // Draw to canvas at target size (transparent bg)
        const canvas = document.createElement('canvas');
        canvas.width = EXPORT_W;
        canvas.height = EXPORT_H;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,EXPORT_W,EXPORT_H);
        // scale the area (440×582) -> EXPORT (3423×4533)
        ctx.drawImage(img, 0, 0, EXPORT_W, EXPORT_H);
        URL.revokeObjectURL(url);

        canvas.toBlob((blob) => {
          if(!blob){ alert('Failed to create PNG'); return; }
          const a = document.createElement('a');
          const pngUrl = URL.createObjectURL(blob);
          a.href = pngUrl;
          a.download = `design-${selectedColor?.slug || 'export'}-${EXPORT_W}x${EXPORT_H}.png`;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(pngUrl);
        }, 'image/png');
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        alert('Could not render the SVG for export.');
      };
      img.src = url;
    });

    // Initial render
    render();
  </script>
</body>
</html>
